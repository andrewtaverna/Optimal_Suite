var PayolaCheckout={initialize:function(){$(document).on("click",".payola-checkout-button",function(e){e.preventDefault(),PayolaCheckout.handleCheckoutButtonClick($(this))})},handleCheckoutButtonClick:function(e){var t=e.parent("form"),a=t.data(),o=StripeCheckout.configure({key:a.publishable_key,image:a.product_image_path,token:function(e){PayolaCheckout.tokenHandler(e,a)},name:a.name,description:a.description,amount:a.price,panelLabel:a.panel_label,allowRememberMe:a.allow_remember_me,zipCode:a.verify_zip_code,billingAddress:a.billing_address,shippingAddress:a.shipping_address,currency:a.currency,bitcoin:a.bitcoin,email:a.email||void 0});o.open()},tokenHandler:function(e,t){var a=$("#"+t.form_id);console.log(t.form_id),a.append($('<input type="hidden" name="stripeToken">').val(e.id)),a.append($('<input type="hidden" name="stripeEmail">').val(e.email)),t.signed_custom_fields&&a.append($('<input type="hidden" name="signed_custom_fields">').val(t.signed_custom_fields)),$(".payola-checkout-button").prop("disabled",!0),$(".payola-checkout-button-text").hide(),$(".payola-checkout-button-spinner").show(),$.ajax({type:"POST",url:t.base_path+"/buy/"+t.product_class+"/"+t.product_permalink,data:a.serialize(),success:function(e){PayolaCheckout.poll(e.guid,60,t)},error:function(e){PayolaCheckout.showError(e.responseJSON.error,t)}})},showError:function(e,t){var a=$("#"+t.error_div_id);a.html(e),a.show(),$(".payola-checkout-button").prop("disabled",!1),$(".payola-checkout-button-spinner").hide(),$(".payola-checkout-button-text").show()},poll:function(e,t,a){if(0===t)return void PayolaCheckout.showError("This seems to be taking too long. Please contact support and give them transaction ID: "+e,a);var o=function(o){"finished"===o.status?window.location=a.base_path+"/confirm/"+e:"errored"===o.status?PayolaCheckout.showError(o.error,a):setTimeout(function(){PayolaCheckout.poll(e,t-1,a)},500)};$.ajax({type:"GET",url:a.base_path+"/status/"+e,success:o,error:o})}};$(function(){PayolaCheckout.initialize()});var PayolaPaymentForm={initialize:function(){$(document).on("submit",".payola-payment-form",function(){return PayolaPaymentForm.handleSubmit($(this))})},handleSubmit:function(e){return e.find(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(t,a){PayolaPaymentForm.stripeResponseHandler(e,t,a)}),!1},stripeResponseHandler:function(e,t,a){if(a.error)PayolaPaymentForm.showError(e,a.error.message);else{var o=e.find("[data-payola='email']").val(),n=e.data("payola-base-path"),i=e.data("payola-product"),r=e.data("payola-permalink"),p=$("<form></form>");p.append($('<input type="hidden" name="stripeToken">').val(a.id)),p.append($('<input type="hidden" name="stripeEmail">').val(o)),p.append(PayolaPaymentForm.authenticityTokenInput()),$.ajax({type:"POST",url:n+"/buy/"+i+"/"+r,data:p.serialize(),success:function(t){PayolaPaymentForm.poll(e,60,t.guid,n)},error:function(t){PayolaPaymentForm.showError(e,t.responseJSON.error)}})}},poll:function(e,t,a,o){0===t&&PayolaPaymentForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+a),$.get(o+"/status/"+a,function(n){"finished"===n.status?(e.append($('<input type="hidden" name="payola_sale_guid"></input>').val(a)),e.append(PayolaPaymentForm.authenticityTokenInput()),e.get(0).submit()):"errored"===n.status?PayolaPaymentForm.showError(e,n.error):setTimeout(function(){PayolaPaymentForm.poll(e,t-1,a,o)},500)})},showError:function(e,t){$(".payola-spinner").hide(),e.find(":submit").prop("disabled",!1);var a=e.data("payola-error-selector");a?$(a).text(t):e.find(".payola-payment-error").text(t)},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};$(function(){PayolaPaymentForm.initialize()});var PayolaSubscriptionCheckout={initialize:function(){$(document).on("click",".payola-subscription-checkout-button",function(e){e.preventDefault(),PayolaSubscriptionCheckout.handleCheckoutButtonClick($(this))})},handleCheckoutButtonClick:function(e){var t=e.parent("form"),a=t.data(),o=StripeCheckout.configure({key:a.publishable_key,image:a.plan_image_path,token:function(e){PayolaSubscriptionCheckout.tokenHandler(e,a)},name:a.name,description:a.description,amount:a.price,panelLabel:a.panel_label,allowRememberMe:a.allow_remember_me,zipCode:a.verify_zip_code,billingAddress:a.billing_address,shippingAddress:a.shipping_address,currency:a.currency,email:a.email||void 0});o.open()},tokenHandler:function(e,t){var a=$("#"+t.form_id);console.log(t.form_id),a.append($('<input type="hidden" name="stripeToken">').val(e.id)),a.append($('<input type="hidden" name="stripeEmail">').val(e.email)),a.append($('<input type="hidden" name="quantity">').val(t.quantity)),t.signed_custom_fields&&a.append($('<input type="hidden" name="signed_custom_fields">').val(t.signed_custom_fields)),$(".payola-subscription-checkout-button").prop("disabled",!0),$(".payola-subscription-checkout-button-text").hide(),$(".payola-subscription-checkout-button-spinner").show(),$.ajax({type:"POST",url:a.attr("action"),data:a.serialize(),success:function(e){PayolaSubscriptionCheckout.poll(e.guid,60,t)},error:function(e){PayolaSubscriptionCheckout.showError(e.responseJSON.error,t)}})},showError:function(e,t){var a=$("#"+t.error_div_id);a.html(e),a.show(),$(".payola-subscription-checkout-button").prop("disabled",!1),$(".payola-subscription-checkout-button-spinner").hide(),$(".payola-subscription-checkout-button-text").show()},poll:function(e,t,a){if(0===t)return void PayolaSubscriptionCheckout.showError("This seems to be taking too long. Please contact support and give them transaction ID: "+e,a);var o=function(o){"active"===o.status?window.location=a.base_path+"/confirm_subscription/"+e:"errored"===o.status?PayolaSubscriptionCheckout.showError(o.error,a):setTimeout(function(){PayolaSubscriptionCheckout.poll(e,t-1,a)},500)};$.ajax({type:"GET",url:a.base_path+"/subscription_status/"+e,success:o,error:o})}};$(function(){PayolaSubscriptionCheckout.initialize()});var PayolaOnestepSubscriptionForm={initialize:function(){$(document).on("submit",".payola-onestep-subscription-form",function(){return PayolaOnestepSubscriptionForm.handleSubmit($(this))})},handleSubmit:function(e){return $(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(t,a){PayolaOnestepSubscriptionForm.stripeResponseHandler(e,t,a)}),!1},stripeResponseHandler:function(e,t,a){if(a.error)PayolaOnestepSubscriptionForm.showError(e,a.error.message);else{var o=e.find("[data-payola='email']").val(),n=e.find("[data-payola='coupon']").val(),i=e.find("[data-payola='quantity']").val(),r=e.data("payola-base-path"),p=e.data("payola-plan-type"),s=e.data("payola-plan-id"),u=$(e).attr("action");e.append($('<input type="hidden" name="plan_type">').val(p)),e.append($('<input type="hidden" name="plan_id">').val(s)),e.append($('<input type="hidden" name="stripeToken">').val(a.id)),e.append($('<input type="hidden" name="stripeEmail">').val(o)),e.append($('<input type="hidden" name="coupon">').val(n)),e.append($('<input type="hidden" name="quantity">').val(i)),e.append(PayolaOnestepSubscriptionForm.authenticityTokenInput()),$.ajax({type:"POST",url:u,data:e.serialize(),success:function(t){PayolaOnestepSubscriptionForm.poll(e,60,t.guid,r)},error:function(t){PayolaOnestepSubscriptionForm.showError(e,t.responseJSON.error)}})}},poll:function(e,t,a,o){0===t&&PayolaOnestepSubscriptionForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+a);var n=function(n){"active"===n.status?window.location=o+"/confirm_subscription/"+a:setTimeout(function(){PayolaOnestepSubscriptionForm.poll(e,t-1,a,o)},500)},i=function(t){PayolaOnestepSubscriptionForm.showError(e,t.responseJSON.error)};$.ajax({type:"GET",dataType:"json",url:o+"/subscription_status/"+a,success:n,error:i})},showError:function(e,t){$(".payola-spinner").hide(),$(":submit").prop("disabled",!1);var a=e.data("payola-error-selector");a?($(a).text(t),$(a).show()):(e.find(".payola-payment-error").text(t),e.find(".payola-payment-error").show())},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};$(function(){PayolaOnestepSubscriptionForm.initialize()});var PayolaSubscriptionForm={initialize:function(){$(document).on("submit",".payola-subscription-form",function(){return PayolaSubscriptionForm.handleSubmit($(this))})},handleSubmit:function(e){return $(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(t,a){PayolaSubscriptionForm.stripeResponseHandler(e,t,a)}),!1},stripeResponseHandler:function(e,t,a){if(a.error)PayolaSubscriptionForm.showError(e,a.error.message);else{var o=e.find("[data-payola='email']").val(),n=e.find("[data-payola='coupon']").val(),i=e.find("[data-payola='quantity']").val(),r=e.data("payola-base-path"),p=e.data("payola-plan-type"),s=e.data("payola-plan-id"),u=$("<form></form>");u.append($('<input type="hidden" name="stripeToken">').val(a.id)),u.append($('<input type="hidden" name="stripeEmail">').val(o)),u.append($('<input type="hidden" name="coupon">').val(n)),u.append($('<input type="hidden" name="quantity">').val(i)),u.append(PayolaSubscriptionForm.authenticityTokenInput()),$.ajax({type:"POST",url:r+"/subscribe/"+p+"/"+s,data:u.serialize(),success:function(t){PayolaSubscriptionForm.poll(e,60,t.guid,r)},error:function(t){PayolaSubscriptionForm.showError(e,t.responseJSON.error)}})}},poll:function(e,t,a,o){0===t&&PayolaSubscriptionForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+a);var n=function(n){"active"===n.status?(e.append($('<input type="hidden" name="payola_subscription_guid"></input>').val(a)),e.append(PayolaSubscriptionForm.authenticityTokenInput()),e.get(0).submit()):setTimeout(function(){PayolaSubscriptionForm.poll(e,t-1,a,o)},500)},i=function(t){"errored"===t.responseJSON.status&&PayolaSubscriptionForm.showError(e,t.responseJSON.error)};$.ajax({type:"GET",dataType:"json",url:o+"/subscription_status/"+a,success:n,error:i})},showError:function(e,t){$(".payola-spinner").hide(),$(":submit").prop("disabled",!1);var a=e.data("payola-error-selector");a?($(a).text(t),$(a).show()):(e.find(".payola-payment-error").text(t),e.find(".payola-payment-error").show())},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};$(function(){PayolaSubscriptionForm.initialize()});