var PayolaCheckout={initialize:function(){$(".payola-checkout-button").on("click",function(e){e.preventDefault(),PayolaCheckout.handleCheckoutButtonClick($(this))})},handleCheckoutButtonClick:function(e){var a=e.parent("form"),t=a.data(),n=StripeCheckout.configure({key:t.publishable_key,image:t.product_image_path,token:function(e){PayolaCheckout.tokenHandler(e,t)},name:t.name,description:t.description,amount:t.price,panelLabel:t.panel_label,allowRememberMe:t.allow_remember_me,zipCode:t.verify_zip_code,billingAddress:t.billing_address,shippingAddress:t.shipping_address,currency:t.currency,bitcoin:t.bitcoin,email:t.email||void 0});n.open()},tokenHandler:function(e,a){var t=$("#"+a.form_id);t.append($('<input type="hidden" name="stripeToken">').val(e.id)),t.append($('<input type="hidden" name="stripeEmail">').val(e.email)),a.signed_custom_fields&&t.append($('<input type="hidden" name="signed_custom_fields">').val(a.signed_custom_fields)),$(".payola-checkout-button").prop("disabled",!0),$(".payola-checkout-button-text").hide(),$(".payola-checkout-button-spinner").show(),$.ajax({type:"POST",url:a.base_path+"/buy/"+a.product_class+"/"+a.product_permalink,data:t.serialize(),success:function(e){PayolaCheckout.poll(e.guid,60,a)},error:function(e){PayolaCheckout.showError(jQuery.parseJSON(e.responseText).error,a)}})},showError:function(e,a){var t=$("#"+a.error_div_id);t.html(e),t.show(),$(".payola-checkout-button").prop("disabled",!1),$(".payola-checkout-button-spinner").hide(),$(".payola-checkout-button-text").show()},poll:function(e,a,t){if(0===a)return void PayolaCheckout.showError("This seems to be taking too long. Please contact support and give them transaction ID: "+e,t);var n=function(n){"finished"===n.status?window.location=t.base_path+"/confirm/"+e:"errored"===n.status?PayolaCheckout.showError(n.error,t):setTimeout(function(){PayolaCheckout.poll(e,a-1,t)},500)};$.ajax({type:"GET",url:t.base_path+"/status/"+e,success:n,error:function(e){n(jQuery.parseJSON(e.responseText))}})}};"undefined"!=typeof Turbolinks?$(document).on("page:change",PayolaCheckout.initialize):$(document).ready(PayolaCheckout.initialize);var PayolaPaymentForm={initialize:function(){$(".payola-payment-form").on("submit",function(){return PayolaPaymentForm.handleSubmit($(this))})},handleSubmit:function(e){return e.find(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(a,t){PayolaPaymentForm.stripeResponseHandler(e,a,t)}),!1},stripeResponseHandler:function(e,a,t){if(t.error)PayolaPaymentForm.showError(e,t.error.message);else{var n=e.find("[data-payola='email']").val(),o=e.data("payola-base-path"),i=e.data("payola-product"),r=e.data("payola-permalink"),p=$("<form></form>");p.append($('<input type="hidden" name="stripeToken">').val(t.id)),p.append($('<input type="hidden" name="stripeEmail">').val(n)),p.append(PayolaPaymentForm.authenticityTokenInput()),$.ajax({type:"POST",url:o+"/buy/"+i+"/"+r,data:p.serialize(),success:function(a){PayolaPaymentForm.poll(e,60,a.guid,o)},error:function(a){PayolaPaymentForm.showError(e,jQuery.parseJSON(a.responseText).error)}})}},poll:function(e,a,t,n){0===a&&PayolaPaymentForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+t),$.get(n+"/status/"+t,function(o){"finished"===o.status?(e.append($('<input type="hidden" name="payola_sale_guid"></input>').val(t)),e.append(PayolaPaymentForm.authenticityTokenInput()),e.get(0).submit()):"errored"===o.status?PayolaPaymentForm.showError(e,o.error):setTimeout(function(){PayolaPaymentForm.poll(e,a-1,t,n)},500)})},showError:function(e,a){$(".payola-spinner").hide(),$(e).find(":submit").prop("disabled",!1).trigger("error",a);var t=e.data("payola-error-selector");t?$(t).text(a):e.find(".payola-payment-error").text(a)},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};"undefined"!=typeof Turbolinks?$(document).on("page:change",PayolaPaymentForm.initialize):$(document).ready(PayolaPaymentForm.initialize);var PayolaSubscriptionCheckout={initialize:function(){$(".payola-subscription-checkout-button").on("click",function(e){e.preventDefault(),PayolaSubscriptionCheckout.handleCheckoutButtonClick($(this))})},handleCheckoutButtonClick:function(e){var a=e.parent("form"),t=a.data();if(t.stripe_customer_id)PayolaSubscriptionCheckout.submitForm(a.attr("action"),{stripe_customer_id:t.stripe_customer_id},t);else{var n=StripeCheckout.configure({key:t.publishable_key,image:t.plan_image_path,token:function(e){PayolaSubscriptionCheckout.tokenHandler(e,t)},name:t.name,description:t.description,amount:t.price+t.price*(t.tax_percent/100),panelLabel:t.panel_label,allowRememberMe:t.allow_remember_me,zipCode:t.verify_zip_code,billingAddress:t.billing_address,shippingAddress:t.shipping_address,currency:t.currency,email:t.email||void 0});n.open()}},tokenHandler:function(e,a){var t=$("#"+a.form_id);t.append($('<input type="hidden" name="stripeToken">').val(e.id)),t.append($('<input type="hidden" name="stripeEmail">').val(e.email)),t.append($('<input type="hidden" name="quantity">').val(a.quantity)),t.append($('<input type="hidden" name="coupon">').val(a.coupon)),t.append($('<input type="hidden" name="tax_percent">').val(a.tax_percent)),a.signed_custom_fields&&t.append($('<input type="hidden" name="signed_custom_fields">').val(a.signed_custom_fields)),PayolaSubscriptionCheckout.submitForm(t.attr("action"),t.serialize(),a)},submitForm:function(e,a,t){$(".payola-subscription-checkout-button").prop("disabled",!0),$(".payola-subscription-checkout-button-text").hide(),$(".payola-subscription-checkout-button-spinner").show(),$.ajax({type:"POST",url:e,data:a,success:function(e){PayolaSubscriptionCheckout.poll(e.guid,60,t)},error:function(e){PayolaSubscriptionCheckout.showError(jQuery.parseJSON(e.responseText).error,t)}})},showError:function(e,a){var t=$("#"+a.error_div_id);t.html(e),t.show(),$(".payola-subscription-checkout-button").prop("disabled",!1).trigger("error",e),$(".payola-subscription-checkout-button-spinner").hide(),$(".payola-subscription-checkout-button-text").show()},poll:function(e,a,t){if(0===a)return void PayolaSubscriptionCheckout.showError("This seems to be taking too long. Please contact support and give them transaction ID: "+e,t);var n=function(n){"active"===n.status?window.location=t.base_path+"/confirm_subscription/"+e:"errored"===n.status?PayolaSubscriptionCheckout.showError(n.error,t):setTimeout(function(){PayolaSubscriptionCheckout.poll(e,a-1,t)},500)};$.ajax({type:"GET",url:t.base_path+"/subscription_status/"+e,success:n,error:function(e){n(jQuery.parseJSON(e.responseText))}})}};"undefined"!=typeof Turbolinks?$(document).on("page:change",PayolaSubscriptionCheckout.initialize):$(document).ready(PayolaSubscriptionCheckout.initialize);var PayolaOnestepSubscriptionForm={initialize:function(){$(".payola-onestep-subscription-form").on("submit",function(){return PayolaOnestepSubscriptionForm.handleSubmit($(this))})},handleSubmit:function(e){return $(e).find(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(a,t){PayolaOnestepSubscriptionForm.stripeResponseHandler(e,a,t)}),!1},stripeResponseHandler:function(e,a,t){if(t.error)PayolaOnestepSubscriptionForm.showError(e,t.error.message);else{var n=e.find("[data-payola='email']").val(),o=e.find("[data-payola='coupon']").val(),i=e.find("[data-payola='quantity']").val(),r=e.data("payola-base-path"),p=e.data("payola-plan-type"),s=e.data("payola-plan-id"),u=$(e).attr("action");e.append($('<input type="hidden" name="plan_type">').val(p)),e.append($('<input type="hidden" name="plan_id">').val(s)),e.append($('<input type="hidden" name="stripeToken">').val(t.id)),e.append($('<input type="hidden" name="stripeEmail">').val(n)),e.append($('<input type="hidden" name="coupon">').val(o)),e.append($('<input type="hidden" name="quantity">').val(i)),e.append(PayolaOnestepSubscriptionForm.authenticityTokenInput()),$.ajax({type:"POST",url:u,data:e.serialize(),success:function(a){PayolaOnestepSubscriptionForm.poll(e,60,a.guid,r)},error:function(a){PayolaOnestepSubscriptionForm.showError(e,jQuery.parseJSON(a.responseText).error)}})}},poll:function(e,a,t,n){0===a&&PayolaOnestepSubscriptionForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+t);var o=function(o){"active"===o.status?window.location=n+"/confirm_subscription/"+t:setTimeout(function(){PayolaOnestepSubscriptionForm.poll(e,a-1,t,n)},500)},i=function(a){PayolaOnestepSubscriptionForm.showError(e,jQuery.parseJSON(a.responseText).error)};$.ajax({type:"GET",dataType:"json",url:n+"/subscription_status/"+t,success:o,error:i})},showError:function(e,a){$(".payola-spinner").hide(),$(e).find(":submit").prop("disabled",!1).trigger("error",a);var t=e.data("payola-error-selector");t?($(t).text(a),$(t).show()):(e.find(".payola-payment-error").text(a),e.find(".payola-payment-error").show())},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};"undefined"!=typeof Turbolinks?$(document).on("page:change",PayolaOnestepSubscriptionForm.initialize):$(document).ready(PayolaOnestepSubscriptionForm.initialize);var PayolaRegistrationForm={initialize:function(){$(".payola-register-form").on("submit",function(e){return e.preventDefault(),PayolaRegistrationForm.handleSubmit($(this))})},handleSubmit:function(e){return $(e).find(":submit").prop("disabled",!0),$(".payola-spinner").show(),PayolaRegistrationForm.makeCustomer(e),!1},makeCustomer:function(e){var a=e.find("[data-payola='email']").val(),t=e.find("[data-payola='coupon']").val(),n=e.find("[data-payola='quantity']").val(),o=e.data("payola-base-path"),i=e.data("payola-plan-type"),r=e.data("payola-plan-id"),p=$(e).attr("action");e.append($('<input type="hidden" name="[user]plan_id">').val(r)),e.append($('<input type="hidden" name="plan_type">').val(i)),e.append($('<input type="hidden" name="plan_id">').val(r)),e.append($('<input type="hidden" name="stripeEmail">').val(a)),e.append($('<input type="hidden" name="coupon">').val(t)),e.append($('<input type="hidden" name="quantity">').val(n)),e.append(PayolaRegistrationForm.authenticityTokenInput()),$.ajax({type:"POST",url:p,data:e.serialize(),success:function(a){PayolaRegistrationForm.poll(e,60,a.guid,o)},error:function(a){PayolaRegistrationForm.showError(e,jQuery.parseJSON(a.responseText).error)}})},poll:function(e,a,t,n){0===a&&PayolaRegistrationForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+t);var o=function(o){"active"===o.status?(e.append($('<input type="hidden" name="payola_subscription_guid"></input>').val(t)),e.append(PayolaRegistrationForm.authenticityTokenInput()),e.get(0).submit()):setTimeout(function(){PayolaRegistrationForm.poll(e,a-1,t,n)},500)},i=function(a){var t=jQuery.parseJSON(a.responseText);"errored"===t.status&&PayolaRegistrationForm.showError(e,t.error)};$.ajax({type:"GET",dataType:"json",url:n+"/subscription_status/"+t,success:o,error:i})},showError:function(e,a){$(".payola-spinner").hide(),$(e).find(":submit").prop("disabled",!1);var t=e.data("payola-error-selector");t?($(t).text(a),$(t).show()):(e.find(".payola-payment-error").text(a),e.find(".payola-payment-error").show())},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};"undefined"!=typeof Turbolinks?$(document).on("page:change",PayolaRegistrationForm.initialize):$(document).ready(PayolaRegistrationForm.initialize);var PayolaSubscriptionForm={initialize:function(){$(".payola-subscription-form").on("submit",function(){return PayolaSubscriptionForm.handleSubmit($(this))})},handleSubmit:function(e){return $(e).find(":submit").prop("disabled",!0),$(".payola-spinner").show(),Stripe.card.createToken(e,function(a,t){PayolaSubscriptionForm.stripeResponseHandler(e,a,t)}),!1},stripeResponseHandler:function(e,a,t){if(t.error)PayolaSubscriptionForm.showError(e,t.error.message);else{var n=e.find("[data-payola='email']").val(),o=e.find("[data-payola='coupon']").val(),i=e.find("[data-payola='quantity']").val(),r=e.data("payola-base-path"),p=e.data("payola-plan-type"),s=e.data("payola-plan-id"),u=$("<form></form>");u.append($('<input type="hidden" name="stripeToken">').val(t.id)),u.append($('<input type="hidden" name="stripeEmail">').val(n)),u.append($('<input type="hidden" name="coupon">').val(o)),u.append($('<input type="hidden" name="quantity">').val(i)),u.append(PayolaSubscriptionForm.authenticityTokenInput()),$.ajax({type:"POST",url:r+"/subscribe/"+p+"/"+s,data:u.serialize(),success:function(a){PayolaSubscriptionForm.poll(e,60,a.guid,r)},error:function(a){PayolaSubscriptionForm.showError(e,jQuery.parseJSON(a.responseText).error)}})}},poll:function(e,a,t,n){0===a&&PayolaSubscriptionForm.showError(e,"This seems to be taking too long. Please contact support and give them transaction ID: "+t);var o=function(o){"active"===o.status?(e.append($('<input type="hidden" name="payola_subscription_guid"></input>').val(t)),e.append(PayolaSubscriptionForm.authenticityTokenInput()),e.get(0).submit()):setTimeout(function(){PayolaSubscriptionForm.poll(e,a-1,t,n)},500)},i=function(a){var t=jQuery.parseJSON(a.responseText);"errored"===t.status&&PayolaSubscriptionForm.showError(e,t.error)};$.ajax({type:"GET",dataType:"json",url:n+"/subscription_status/"+t,success:o,error:i})},showError:function(e,a){$(".payola-spinner").hide(),$(e).find(":submit").prop("disabled",!1).trigger("error",a);var t=e.data("payola-error-selector");t?($(t).text(a),$(t).show()):(e.find(".payola-payment-error").text(a),e.find(".payola-payment-error").show())},authenticityTokenInput:function(){return $('<input type="hidden" name="authenticity_token"></input>').val($('meta[name="csrf-token"]').attr("content"))}};"undefined"!=typeof Turbolinks?$(document).on("page:change",PayolaSubscriptionForm.initialize):$(document).ready(PayolaSubscriptionForm.initialize);